import { User } from "@supabase/supabase-js";

import {
  CloudAccessLevel,
  CloudAccessRow,
  CloudLogRow,
  CloudProfileRow,
  CloudProjectRow,
  PlatformProfileRow,
  PlatformRole,
} from "@/components/author-studio-types";
import { HelpHint } from "@/components/HelpHint";

interface AuthorStudioCloudPanelProps {
  supabaseEnabled: boolean;
  allowSelfSignup: boolean;
  authLoading: boolean;
  authUser: User | null;
  authEmailInput: string;
  authPasswordInput: string;
  platformRole: PlatformRole;
  isPlatformAdmin: boolean;
  onAuthEmailInputChange: (value: string) => void;
  onAuthPasswordInputChange: (value: string) => void;
  onSignIn: () => void;
  onSignUp: () => void;
  onSignOut: () => void;
  ownPasswordInput: string;
  ownPasswordConfirmInput: string;
  accountMustChangePassword: boolean;
  onOwnPasswordInputChange: (value: string) => void;
  onOwnPasswordConfirmInputChange: (value: string) => void;
  onChangeOwnPassword: () => void;
  onRefreshProjects: () => void;
  onSaveProject: () => void;
  onAcquireLock: () => void;
  onReleaseLock: () => void;
  onForceTakeoverLock: () => void;
  cloudBusy: boolean;
  cloudCanWrite: boolean;
  cloudProjectId: string | null;
  cloudAccessLevel: CloudAccessLevel | null;
  cloudProjectUpdatedAt: string | null;
  cloudEditingLockUserId: string | null;
  cloudLockHolderName: string;
  cloudLockHeldByOther: boolean;
  cloudProjects: CloudProjectRow[];
  onOpenProject: (projectId: string) => void;
  onDownloadProjectBundle: (projectId: string) => void;
  canEdit: boolean;
  onCleanupLocalOrphanAssetRefs: () => void;
  onCleanupCloudOrphanAssets: () => void;
  cloudCanManageAccess: boolean;
  shareEmailInput: string;
  onShareEmailInputChange: (value: string) => void;
  shareAccessLevel: "read" | "write";
  onShareAccessLevelChange: (value: "read" | "write") => void;
  onGrantAccess: () => void;
  cloudAccessRows: CloudAccessRow[];
  cloudProfiles: Record<string, CloudProfileRow>;
  onRevokeAccess: (userId: string) => void;
  cloudLogs: CloudLogRow[];
  platformProfiles: PlatformProfileRow[];
  adminCreateUserEmailInput: string;
  adminCreateUserPasswordInput: string;
  adminCreateUserRole: PlatformRole;
  onAdminCreateUserEmailInputChange: (value: string) => void;
  onAdminCreateUserPasswordInputChange: (value: string) => void;
  onAdminCreateUserRoleChange: (value: PlatformRole) => void;
  onAdminCreateUser: () => void;
  onRefreshPlatformProfiles: () => void;
  onSetPlatformProfileRole: (userId: string, role: PlatformRole) => void;
}

export function AuthorStudioCloudPanel({
  supabaseEnabled,
  allowSelfSignup,
  authLoading,
  authUser,
  authEmailInput,
  authPasswordInput,
  platformRole,
  isPlatformAdmin,
  onAuthEmailInputChange,
  onAuthPasswordInputChange,
  onSignIn,
  onSignUp,
  onSignOut,
  ownPasswordInput,
  ownPasswordConfirmInput,
  accountMustChangePassword,
  onOwnPasswordInputChange,
  onOwnPasswordConfirmInputChange,
  onChangeOwnPassword,
  onRefreshProjects,
  onSaveProject,
  onAcquireLock,
  onReleaseLock,
  onForceTakeoverLock,
  cloudBusy,
  cloudCanWrite,
  cloudProjectId,
  cloudAccessLevel,
  cloudProjectUpdatedAt,
  cloudEditingLockUserId,
  cloudLockHolderName,
  cloudLockHeldByOther,
  cloudProjects,
  onOpenProject,
  onDownloadProjectBundle,
  canEdit,
  onCleanupLocalOrphanAssetRefs,
  onCleanupCloudOrphanAssets,
  cloudCanManageAccess,
  shareEmailInput,
  onShareEmailInputChange,
  shareAccessLevel,
  onShareAccessLevelChange,
  onGrantAccess,
  cloudAccessRows,
  cloudProfiles,
  onRevokeAccess,
  cloudLogs,
  platformProfiles,
  adminCreateUserEmailInput,
  adminCreateUserPasswordInput,
  adminCreateUserRole,
  onAdminCreateUserEmailInputChange,
  onAdminCreateUserPasswordInputChange,
  onAdminCreateUserRoleChange,
  onAdminCreateUser,
  onRefreshPlatformProfiles,
  onSetPlatformProfileRole,
}: AuthorStudioCloudPanelProps) {
  const adminCount = platformProfiles.filter((profile) => profile.platform_role === "admin").length;
  const maskEmail = (email: string | null | undefined) => {
    if (!email) return null;
    const [local, domain] = email.split("@");
    if (!local || !domain) return email;
    const head = local.slice(0, 2);
    return `${head}***@${domain}`;
  };
  const displayEmail = (email: string | null | undefined) => {
    if (!email) return null;
    return isPlatformAdmin ? email : maskEmail(email);
  };

  return (
    <aside className="panel panel-cloud">
      <section className="panel-section">
        <div className="title-with-help">
          <h2>Supabase Cloud</h2>
          <HelpHint title="Connexion cloud">
            Espace de connexion et sauvegarde en ligne. Depuis ici, tu te connectes, tu
            sauvegardes le projet actif et tu geres le verrou d&apos;edition cloud.
          </HelpHint>
        </div>
        {!supabaseEnabled && (
          <p className="empty-placeholder">
            Configure `NEXT_PUBLIC_SUPABASE_URL` et `NEXT_PUBLIC_SUPABASE_ANON_KEY` (ou
            `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`).
          </p>
        )}

        {supabaseEnabled && (
          <>
            {authLoading && <p>Chargement session...</p>}

            {!authLoading && !authUser && (
              <div className="subsection">
                <label>
                  Email
                  <input
                    type="email"
                    placeholder="auteur@studio.com"
                    value={authEmailInput ?? ""}
                    onChange={(event) => onAuthEmailInputChange(event.target.value)}
                  />
                </label>
                <label>
                  Mot de passe
                  <input
                    type="password"
                    placeholder="********"
                    value={authPasswordInput ?? ""}
                    onChange={(event) => onAuthPasswordInputChange(event.target.value)}
                  />
                </label>
                <div className="row-inline">
                  <button className="button-secondary" onClick={onSignIn} disabled={cloudBusy}>
                    Se connecter
                  </button>
                  {allowSelfSignup && (
                    <button className="button-secondary" onClick={onSignUp} disabled={cloudBusy}>
                      Creer un compte
                    </button>
                  )}
                </div>
                <small>
                  {allowSelfSignup
                    ? "`Se connecter` n'ouvre que les comptes existants. `Creer un compte` enregistre un nouveau compte (role lecteur par defaut)."
                    : "Inscription desactivee sur cette instance: demande a un admin de creer/activer ton compte, puis utilise `Se connecter`."}
                </small>
              </div>
            )}

            {authUser && (
              <div className="subsection">
                <p>
                  Connecte: <strong>{displayEmail(authUser.email) ?? authUser.id}</strong>{" "}
                  <span className="chip chip-start">{platformRole}</span>
                </p>
                <div className="cloud-auth-actions">
                  <div className="cloud-auth-top-row">
                    <button className="button-secondary" onClick={onSignOut} disabled={cloudBusy}>
                      Se deconnecter
                    </button>
                    <button
                      className="button-secondary"
                      onClick={onRefreshProjects}
                      disabled={cloudBusy}
                    >
                      Refresh liste
                    </button>
                  </div>
                  <button
                    className="button-primary cloud-save-button"
                    onClick={onSaveProject}
                    disabled={cloudBusy || !cloudCanWrite}
                  >
                    {cloudProjectId ? "Sauvegarder cloud" : "Creer + sauvegarder"}
                  </button>
                  {cloudProjectId && (
                    <div className="cloud-auth-top-row">
                      <button
                        className="button-secondary"
                        onClick={onAcquireLock}
                        disabled={
                          cloudBusy || !cloudCanWrite || cloudEditingLockUserId === authUser.id
                        }
                      >
                        Prendre verrou cloud
                      </button>
                      <button
                        className="button-secondary"
                        onClick={onReleaseLock}
                        disabled={
                          cloudBusy || !cloudProjectId || cloudEditingLockUserId !== authUser.id
                        }
                      >
                        Liberer verrou cloud
                      </button>
                    </div>
                  )}
                  {cloudProjectId && cloudAccessLevel === "owner" && cloudLockHeldByOther && (
                    <button
                      className="button-danger"
                      onClick={onForceTakeoverLock}
                      disabled={cloudBusy}
                    >
                      Reprendre verrou (owner)
                    </button>
                  )}
                </div>
                {cloudProjectId && (
                  <small>
                    Projet cloud actif: <strong>{cloudProjectId}</strong> ({cloudAccessLevel ?? "none"})
                    {cloudProjectUpdatedAt && (
                      <> - rev. {new Date(cloudProjectUpdatedAt).toLocaleString("fr-FR")}</>
                    )}
                    {cloudEditingLockUserId && <> - lock {cloudLockHolderName}</>}
                  </small>
                )}
                <div className="subsection">
                  <div className="title-with-help">
                    <strong>Securite compte</strong>
                    <HelpHint title="Mot de passe utilisateur">
                      Change ton mot de passe ici. Pour un compte cree par un admin, fais ce
                      changement des la premiere connexion.
                    </HelpHint>
                  </div>
                  {accountMustChangePassword && (
                    <p className="empty-placeholder">
                      Action requise: change ton mot de passe provisoire.
                    </p>
                  )}
                  <label>
                    Nouveau mot de passe
                    <input
                      type="password"
                      placeholder="Minimum 8 caracteres"
                      value={ownPasswordInput ?? ""}
                      onChange={(event) => onOwnPasswordInputChange(event.target.value)}
                    />
                  </label>
                  <label>
                    Confirmation mot de passe
                    <input
                      type="password"
                      placeholder="Retape le mot de passe"
                      value={ownPasswordConfirmInput ?? ""}
                      onChange={(event) => onOwnPasswordConfirmInputChange(event.target.value)}
                    />
                  </label>
                  <button
                    className="button-secondary"
                    onClick={onChangeOwnPassword}
                    disabled={cloudBusy}
                  >
                    Changer mon mot de passe
                  </button>
                </div>
              </div>
            )}
          </>
        )}
      </section>

      <section className="panel-section">
        <div className="title-with-help">
          <h2>User name (mail)</h2>
          <HelpHint title="Compte actif">
            Affiche le compte actuellement connecte dans le studio. Si rien n&apos;apparait, aucun
            utilisateur n&apos;est connecte.
          </HelpHint>
        </div>
        <p className="empty-placeholder">{displayEmail(authUser?.email ?? null) ?? "Aucun utilisateur connecte."}</p>
      </section>

      {authUser && (
        <section className="panel-section">
          <div className="title-with-help">
            <h2>Mes projets cloud</h2>
            <HelpHint title="Liste projets">
              Liste des projets ou tu as un droit owner, write ou read. Ouvre un projet pour
              recuperer son graphe et ses assets.
            </HelpHint>
          </div>
          <small>Affiche les projets auxquels ton compte a acces (owner, write, read).</small>
          {cloudProjects.length === 0 ? (
            <p className="empty-placeholder">
              Aucun projet visible. Clique sur Creer + sauvegarder puis sur Refresh liste.
            </p>
          ) : (
            <ul className="list-compact">
              {cloudProjects.map((item) => (
                <li key={item.id} className="cloud-project-row">
                  <div>
                    <strong>{item.title}</strong>
                    <small>{new Date(item.updated_at).toLocaleString("fr-FR")}</small>
                  </div>
                  <div className="row-inline">
                    <span className="chip chip-start">{item.access_level}</span>
                    <button
                      className="button-secondary"
                      onClick={() => onDownloadProjectBundle(item.id)}
                      disabled={cloudBusy}
                    >
                      DL bundle
                    </button>
                    <button
                      className="button-secondary"
                      onClick={() => onOpenProject(item.id)}
                      disabled={cloudBusy}
                    >
                      Ouvrir
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </section>
      )}

      {authUser && isPlatformAdmin && (
        <section className="panel-section">
          <div className="title-with-help">
            <h2>Administration plateforme</h2>
            <HelpHint title="Roles plateforme">
              Zone reservee admin pour promouvoir ou retrograder les comptes entre `reader`,
              `author` et `admin`.
            </HelpHint>
          </div>
          <div className="row-inline">
            <button
              className="button-secondary"
              onClick={onRefreshPlatformProfiles}
              disabled={cloudBusy}
            >
              Refresh utilisateurs
            </button>
            <small>Total: {platformProfiles.length}</small>
          </div>
          <div className="subsection">
            <div className="title-with-help">
              <strong>Creer un compte utilisateur</strong>
              <HelpHint title="Provisionning comptes">
                Cree directement un compte avec email, mot de passe provisoire et grade
                (reader/author/admin).
              </HelpHint>
            </div>
            <label>
              Email utilisateur
                <input
                  type="email"
                  placeholder="utilisateur@studio.com"
                  value={adminCreateUserEmailInput ?? ""}
                  onChange={(event) => onAdminCreateUserEmailInputChange(event.target.value)}
                />
            </label>
            <label>
              Mot de passe provisoire
                <input
                  type="password"
                  placeholder="Minimum 8 caracteres"
                  value={adminCreateUserPasswordInput ?? ""}
                  onChange={(event) => onAdminCreateUserPasswordInputChange(event.target.value)}
                />
            </label>
            <label>
              Grade initial
              <select
                value={adminCreateUserRole ?? "reader"}
                onChange={(event) => onAdminCreateUserRoleChange(event.target.value as PlatformRole)}
              >
                <option value="reader">reader</option>
                <option value="author">author</option>
                <option value="admin">admin</option>
              </select>
            </label>
            <button className="button-primary" onClick={onAdminCreateUser} disabled={cloudBusy}>
              Creer compte
            </button>
          </div>
          {platformProfiles.length === 0 ? (
            <p className="empty-placeholder">Aucun compte utilisateur trouve.</p>
          ) : (
            <ul className="list-compact">
              {platformProfiles.map((profile) => {
                const isAdmin = profile.platform_role === "admin";
                return (
                  <li key={profile.user_id} className="platform-profile-card">
                    <div className="platform-profile-head">
                      <div>
                        <strong>{profile.display_name}</strong>
                        <small>{displayEmail(profile.email) ?? profile.user_id}</small>
                      </div>
                      <span className={`chip ${isAdmin ? "chip-start" : "chip-warning"}`}>
                        {profile.platform_role}
                      </span>
                    </div>
                    <div className="platform-role-actions">
                      <button
                        className="button-secondary"
                        onClick={() => onSetPlatformProfileRole(profile.user_id, "admin")}
                        disabled={cloudBusy || isAdmin}
                      >
                        Passer admin
                      </button>
                      <button
                        className="button-secondary"
                        onClick={() => onSetPlatformProfileRole(profile.user_id, "author")}
                        disabled={
                          cloudBusy ||
                          profile.platform_role === "author" ||
                          (isAdmin && adminCount <= 1)
                        }
                      >
                        Passer auteur
                      </button>
                      <button
                        className="button-secondary"
                        onClick={() => onSetPlatformProfileRole(profile.user_id, "reader")}
                        disabled={
                          cloudBusy ||
                          profile.platform_role === "reader" ||
                          (isAdmin && adminCount <= 1)
                        }
                      >
                        Passer lecteur
                      </button>
                    </div>
                  </li>
                );
              })}
            </ul>
          )}
        </section>
      )}

      {isPlatformAdmin && (
        <section className="panel-section">
          <div className="title-with-help">
            <h2>Maintenance assets</h2>
            <HelpHint title="Nettoyage">
              Outils admin pour supprimer les references ou fichiers assets inutilises.
              Utiliser apres sauvegarde cloud.
            </HelpHint>
          </div>
          <p className="empty-placeholder">
            Nettoie les references assets non utilisees et les fichiers cloud orphelins.
          </p>
          <div className="row-inline">
            <button
              className="button-secondary"
              onClick={onCleanupLocalOrphanAssetRefs}
              disabled={!canEdit}
            >
              Nettoyer refs locales
            </button>
            <button
              className="button-secondary"
              onClick={onCleanupCloudOrphanAssets}
              disabled={cloudBusy || !authUser || !cloudProjectId || !cloudCanWrite}
            >
              Nettoyer assets cloud
            </button>
          </div>
          <small>Conseil: fais d&apos;abord une sauvegarde cloud, puis lance la purge cloud.</small>
        </section>
      )}

      {cloudProjectId && isPlatformAdmin && (
        <section className="panel-section">
          <div className="title-with-help">
            <h2>Droits cloud</h2>
            <HelpHint title="Partage projet">
              Permet de donner ou retirer l&apos;acces a un projet cloud. Le niveau `write` autorise
              l&apos;edition, `read` autorise uniquement la lecture.
            </HelpHint>
          </div>
          {cloudAccessLevel !== "owner" && (
            <p className="empty-placeholder">Seul le owner peut modifier les droits du projet.</p>
          )}

          {cloudCanManageAccess && (
            <div className="subsection">
              <label>
                Email collaborateur
                <input
                  type="email"
                  placeholder="auteur@studio.com"
                  value={shareEmailInput}
                  onChange={(event) => onShareEmailInputChange(event.target.value)}
                />
              </label>
              <label>
                Niveau
                <select
                  value={shareAccessLevel}
                  onChange={(event) => onShareAccessLevelChange(event.target.value as "read" | "write")}
                >
                  <option value="write">write</option>
                  <option value="read">read</option>
                </select>
              </label>
              <button className="button-secondary" onClick={onGrantAccess} disabled={cloudBusy}>
                Donner acces
              </button>
            </div>
          )}

          <ul className="list-compact">
            {cloudAccessRows.map((row) => {
              const profile = cloudProfiles[row.user_id];
              return (
                <li key={row.user_id} className="cloud-access-row">
                  <div>
                    <strong>{profile?.display_name ?? row.user_id}</strong>
                    <small>{displayEmail(profile?.email ?? null) ?? row.user_id}</small>
                  </div>
                  <div className="row-inline">
                    <span className="chip chip-start">{row.access_level}</span>
                    {cloudCanManageAccess && row.access_level !== "owner" && (
                      <button
                        className="button-danger"
                        onClick={() => onRevokeAccess(row.user_id)}
                        disabled={cloudBusy}
                      >
                        Retirer
                      </button>
                    )}
                  </div>
                </li>
              );
            })}
          </ul>
        </section>
      )}

      {cloudProjectId && cloudLogs.length > 0 && (
        <section className="panel-section">
          <div className="title-with-help">
            <h2>Logs cloud</h2>
            <HelpHint title="Historique cloud">
              Journal des actions cloud sur le projet courant: ouvertures, sauvegardes, droits et
              verrous.
            </HelpHint>
          </div>
          <ul className="log-list">
            {cloudLogs.map((entry) => {
              const profile = cloudProfiles[entry.actor_id];
              return (
                <li key={entry.id}>
                  <strong>{entry.action}</strong>
                  <p>{entry.details}</p>
                  <small>
                    {profile?.display_name ?? entry.actor_id} -{" "}
                    {new Date(entry.created_at).toLocaleString("fr-FR")}
                  </small>
                </li>
              );
            })}
          </ul>
        </section>
      )}
    </aside>
  );
}
